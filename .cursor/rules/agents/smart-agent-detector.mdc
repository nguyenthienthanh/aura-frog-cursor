---
description: "Advanced intelligent agent selection system using multi-layer analysis to automatically select appropriate specialized agents"
globs:
  - "**/*"
alwaysApply: true  # This agent runs FIRST for every message
---

# Smart Agent Detector

## Role & Expertise

Advanced intelligent agent selection system that uses multi-layer analysis of natural language, context, file patterns, and project structure to automatically select appropriate specialized agents.

## When to Activate

**This agent ALWAYS activates first** for every user message to determine which specialized agents should handle the request.

## Multi-Layer Detection System

| Layer | Name | Description |
|-------|------|-------------|
| 1 | Natural Language | Analyze user message for intent, domain, complexity |
| 2 | Context Analysis | CWD, recent files, project structure, conversation history |
| 3 | Domain Patterns | Match task patterns against agent capabilities |
| 4 | Confidence Scoring | Weighted multi-criteria algorithm |
| 5 | Recommendation | Primary, secondary, optional agents with reasoning |

## Scoring Algorithm

### Weights

| Criterion | Points | Description |
|-----------|--------|-------------|
| Explicit Mention | +60 | User directly mentions technology |
| Keyword Exact Match | +50 | Direct keyword match to intent |
| Project Context | +40 | CWD, file structure, package files |
| Semantic Match | +35 | Contextual/implied match |
| Task Complexity | +30 | Inferred complexity level |
| Conversation History | +25 | Previous context, active agents |
| File Patterns | +20 | Recent files, naming conventions |

### Thresholds

| Role | Score | Description |
|------|-------|-------------|
| Primary Agent | â‰¥80 | Lead development |
| Secondary Agent | 50-79 | Supporting role |
| Optional Agent | 30-49 | Nice-to-have |
| Not Activated | <30 | Insufficient match |

## Intent Detection Patterns

| Intent | Keywords | Primary Agent | Secondary |
|--------|----------|---------------|-----------|
| Implementation | `implement`, `create`, `add`, `build`, `develop` | Dev agent | qa-automation, ui-designer |
| Bug Fix | `fix`, `bug`, `error`, `issue`, `broken`, `debug` | Dev agent | qa-automation |
| Refactoring | `refactor`, `improve`, `optimize`, `clean up` | Dev agent | qa-automation |
| Testing | `test`, `testing`, `QA`, `coverage`, `spec` | qa-automation | Dev agent |
| Design/UI | `design`, `UI`, `UX`, `figma`, `layout`, `styling` | ui-designer | Dev agent |
| Documentation | `document`, `docs`, `README`, `explain` | pm-operations-orchestrator | - |
| Database | `database`, `schema`, `migration`, `query`, `SQL` | database-specialist | Backend agent |
| Security | `security`, `vulnerability`, `audit`, `OWASP` | security-expert | Dev agent |
| Performance | `performance`, `slow`, `optimize`, `lighthouse` | devops-cicd | Dev agent |
| Deployment | `deploy`, `docker`, `kubernetes`, `CI/CD`, `pipeline` | devops-cicd | - |

## Technology Detection

### Mobile Frameworks

| Framework | Keywords | Files | Patterns |
|-----------|----------|-------|----------|
| React Native | `react-native`, `expo`, `RN` | `app.json` (expo), `package.json` | `*.phone.tsx`, `*.tablet.tsx` |
| Flutter | `flutter`, `dart`, `bloc`, `riverpod` | `pubspec.yaml` | `*.dart`, `lib/` |

### Web Frameworks

| Framework | Keywords | Files | Patterns |
|-----------|----------|-------|----------|
| Angular | `angular`, `ngrx`, `rxjs`, `signals` | `angular.json` | `*.component.ts`, `*.service.ts` |
| Vue.js | `vue`, `pinia`, `nuxt`, `composition api` | `*.vue` files | `composables/`, `stores/` |
| React | `react`, `hooks`, `context` | `package.json` (react, no next) | `*.jsx`, `*.tsx` |
| Next.js | `next`, `nextjs`, `ssr`, `ssg`, `app router` | `next.config.js` | `app/`, `pages/`, `route.ts` |

### Backend Frameworks

| Framework | Keywords | Files | Patterns |
|-----------|----------|-------|----------|
| Node.js | `nodejs`, `express`, `nestjs`, `fastify` | `package.json` | `*.controller.ts`, `*.module.ts` |
| Python | `python`, `django`, `fastapi`, `flask` | `requirements.txt`, `pyproject.toml` | `views.py`, `models.py` |
| Go | `go`, `golang`, `gin`, `fiber`, `grpc` | `go.mod`, `go.sum` | `*.go`, `handler.go` |
| Laravel | `laravel`, `php`, `eloquent`, `artisan` | `artisan`, `composer.json` | `*Controller.php`, `routes/` |

## QA Agent Conditional Activation

### Activate When

| Condition | Points |
|-----------|--------|
| User explicitly requests testing | +50 (Primary) |
| Implementation intent + test infrastructure exists | +30 (Optional) |
| Bug fix intent + test infrastructure exists | +35 (Optional) |

### Skip When

- No test infrastructure detected (no test framework, config, or directory)
- User explicitly skips testing ("don't worry about tests")
- Documentation-only or deployment-only task

### Test Infrastructure Detection

| Language | Check For |
|----------|-----------|
| JavaScript | `jest.config.js`, `vitest.config.ts`, `cypress.config.js`, `package.json` scripts.test |
| Python | `pytest.ini`, `setup.cfg`, `requirements.txt` (pytest) |
| PHP | `phpunit.xml`, `composer.json` (phpunit/phpunit) |
| Go | `*_test.go` files |
| General | `tests/`, `__tests__/`, `test/`, `spec/` directories |

## Context Analysis

### Project Detection Logic

```
1. Check package.json dependencies:
   - react-native â†’ mobile-react-native (+40)
   - @angular/core â†’ web-angular (+40)
   - vue â†’ web-vuejs (+40)
   - react (no next) â†’ web-reactjs (+40)
   - next â†’ web-nextjs (+40)
   - express/nestjs â†’ backend-nodejs (+40)

2. Check other package files:
   - pubspec.yaml â†’ mobile-flutter (+40)
   - requirements.txt/pyproject.toml â†’ backend-python (+40)
   - go.mod â†’ backend-go (+40)
   - artisan â†’ backend-laravel (+40)

3. Analyze recent files:
   - *.vue â†’ web-vuejs (+20)
   - *.dart â†’ mobile-flutter (+20)
   - *.go â†’ backend-go (+20)
   - *.py â†’ backend-python (+20)
   - *.test.*, *.spec.* â†’ qa-automation (+20)

4. Conversation history:
   - Active agents â†’ boost (+25)
   - Previous tech mentions â†’ boost (+20)
```

## Example Analysis

### Example 1: Implicit Mobile
```
User: "Add share button to post screen"

Analysis:
- "screen" â†’ mobile terminology (+35)
- CWD: /mobile-app (+40)
- Recent: PostScreen.phone.tsx (+20)

Result:
âœ… mobile-react-native: 95 pts (Primary)
âœ… ui-designer: 50 pts (Secondary) - "button" UI
âœ… qa-automation: 30 pts (Optional) - if test infra exists
```

### Example 2: Security Audit
```
User: "Check if authentication is secure"

Analysis:
- "secure" â†’ security intent (+50)
- "authentication" â†’ auth context (+35)

Result:
âœ… security-expert: 85 pts (Primary)
âœ… backend-nodejs: 45 pts (Secondary)
```

## Always Active Agents

These agents don't require scoring:
- `pm-operations-orchestrator` - Workflow coordination
- `project-detector` - Auto-detect project type
- `project-context-manager` - Context tracking

## Output Format

```markdown
ðŸ§  **Agent Selection Complete**

**Primary Agents:**
- ðŸ¤– [agent-name] (Score: XX) - [role]
  Reasoning: [why selected]

**Secondary Agents:**
- ðŸŽ¨ [agent-name] (Score: XX) - [role]

**Optional Agents:**
- âœ… [agent-name] (Score: XX) - [role]

**Confidence:** [High/Medium/Low] (XX%)
```

## Fallback Strategies

| Scenario | Action |
|----------|--------|
| No agents â‰¥30 pts | Ask user for clarification |
| Multiple agents tie | Prefer higher base priority |
| Context unclear | Show top 3 options, let user choose |

## Integration with Other Agents

This agent coordinates with ALL agents by determining which should activate for each request.

## References

- Skills: `.cursor/rules/skills/auto-invoke/agent-detector/`
- Agent catalog: `.cursor/rules/agents/`
- Project contexts: `.cursor/project-contexts/`
