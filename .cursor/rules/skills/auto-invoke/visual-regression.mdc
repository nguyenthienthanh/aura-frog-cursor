---
description: Visual regression testing with closed-loop auto-fix. Compares UI implementation against design references and automatically fixes discrepancies.
globs:
  - "**/*.tsx"
  - "**/*.jsx"
  - "**/*.vue"
  - "**/*.svelte"
  - "**/*.css"
  - "**/*.scss"
alwaysApply: false
---

# Skill: Visual Regression Testing

**Version:** 1.11.0
**Trigger:** Auto-detect design references, workflow phases, UI implementation
**Purpose:** Ensure pixel-perfect UI implementation with auto-fix loop

---

## Overview

Visual regression testing compares the implemented UI against design references (Figma, screenshots) and automatically fixes discrepancies until pixel-perfect match is achieved.

**AUTO-INVOCATION:** This skill triggers automatically - no manual commands needed.

---

## Auto-Detection Triggers

### ğŸ”´ CRITICAL: When to Auto-Run

**1. Design Reference Detected in Task:**
- Figma URL: `figma.com/file/...`, `figma.com/design/...`
- Design files: `*.png`, `*.jpg`, `*.fig` mentioned as reference
- Keywords: "based on design", "match the mockup", "per Figma", "as designed"

**2. Workflow Phase Triggers:**
- **Phase 3 (UI Breakdown):** Store design reference for later comparison
- **Phase 5 (TDD GREEN):** After UI component implementation passes tests
- **Phase 6 (Review):** Run visual regression as part of quality check
- **Phase 7 (Verify):** Final visual validation before approval

**3. UI Implementation Completion:**
- After creating/modifying UI components (`.tsx`, `.jsx`, `.vue`, `.svelte`)
- After updating styles (`.css`, `.scss`, `.tailwind`)
- After fixing visual bugs

### Auto-Detection Rules

```yaml
# Auto-run visual regression when:
triggers:
  patterns:
    - "figma.com/file/*"
    - "figma.com/design/*"
    - "*.fig"
    - "design/*.png"
    - "mockup/*.png"
    - "reference/*.png"
  keywords:
    - "pixel perfect"
    - "match design"
    - "match figma"
    - "per design"
    - "as designed"
    - "visual accuracy"
    - "UI matches"
  workflow_phases:
    - "phase-5b-green"  # After implementation
    - "phase-6-review"  # Quality check
    - "phase-7-verify"  # Final validation
```

---

## Design Reference Storage

When a design reference is detected, store it for the session:

```bash
# Store design reference path
echo "$DESIGN_REFERENCE" > .cursor/visual/reference-path.txt

# Or for Figma
echo "figma://$FILE_ID/$NODE_ID" > .cursor/visual/reference-path.txt
```

This allows visual regression to run automatically at later workflow phases.

---

## Auto-Fix Loop Process

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VISUAL REGRESSION LOOP                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. CAPTURE â”€â”€â–º Take screenshot of implementation            â”‚
â”‚       â”‚                                                      â”‚
â”‚       â–¼                                                      â”‚
â”‚  2. COMPARE â”€â”€â–º Diff against design reference                â”‚
â”‚       â”‚         Calculate pixel difference %                 â”‚
â”‚       â–¼                                                      â”‚
â”‚  3. ANALYZE â”€â”€â–º Identify problem areas                       â”‚
â”‚       â”‚         - Color mismatches                           â”‚
â”‚       â”‚         - Spacing issues                             â”‚
â”‚       â”‚         - Font discrepancies                         â”‚
â”‚       â”‚         - Layout shifts                              â”‚
â”‚       â–¼                                                      â”‚
â”‚  4. CHECK â”€â”€â”€â”€â–º Diff < threshold (default 1%)?               â”‚
â”‚       â”‚                                                      â”‚
â”‚    YES â”‚ NO                                                  â”‚
â”‚       â”‚  â”‚                                                   â”‚
â”‚       â”‚  â–¼                                                   â”‚
â”‚       â”‚  5. FIX â”€â”€â–º Apply targeted CSS/style fixes           â”‚
â”‚       â”‚       â”‚                                              â”‚
â”‚       â”‚       â–¼                                              â”‚
â”‚       â”‚  6. ITERATE â”€â”€â–º Back to step 1 (max 5 iterations)    â”‚
â”‚       â”‚                                                      â”‚
â”‚       â–¼                                                      â”‚
â”‚  âœ“ PASS â”€â”€â”€â”€â–º Pixel-perfect match achieved!                  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Configuration

```yaml
# .cursor/visual-regression.yaml (optional)
visual_regression:
  threshold: 1              # Max allowed pixel diff % (0-100)
  max_iterations: 5         # Max auto-fix attempts
  screenshot_width: 1920    # Viewport width
  screenshot_height: 1080   # Viewport height
  ignore_regions: []        # CSS selectors to ignore
  compare_mode: "pixel"     # pixel | structural | hybrid
```

---

## MCP Integration

### Using Playwright MCP for Screenshots

```javascript
// Capture implementation screenshot
await playwright.screenshot({
  path: '.cursor/visual/current.png',
  fullPage: true
});
```

### Using Figma MCP for Design Reference

```javascript
// Fetch design from Figma
const design = await figma.getImage({
  fileId: 'ABC123',
  nodeId: '1:234',
  format: 'png',
  scale: 2
});
```

---

## Comparison Methods

### 1. Pixel-by-Pixel (Default)

```bash
# Using ImageMagick compare
compare -metric AE current.png reference.png diff.png 2>&1
```

### 2. Perceptual Diff

```bash
# Using pixelmatch (npm)
npx pixelmatch current.png reference.png diff.png 0.1
```

### 3. Structural Similarity

```bash
# Using SSIM
npx ssim current.png reference.png
```

---

## Auto-Fix Strategies

When differences are detected, apply fixes in this order:

### 1. Color Fixes
```css
/* Detected: Color mismatch in header */
.header {
  background-color: #1a1a2e; /* was: #1a1a30 */
}
```

### 2. Spacing Fixes
```css
/* Detected: 4px spacing difference */
.card {
  padding: 16px; /* was: 12px */
  margin-bottom: 24px; /* was: 20px */
}
```

### 3. Typography Fixes
```css
/* Detected: Font size mismatch */
.title {
  font-size: 24px; /* was: 22px */
  line-height: 1.4; /* was: 1.5 */
}
```

### 4. Layout Fixes
```css
/* Detected: Alignment issue */
.container {
  display: flex;
  gap: 16px; /* was: grid with different gap */
}
```

---

## Output Format

After each comparison, report:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¨ VISUAL REGRESSION RESULT                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Reference: figma://ABC123/1:234                              â”‚
â”‚ Comparison: .cursor/visual/current.png                       â”‚
â”‚ Diff Image: .cursor/visual/diff.png                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Pixel Diff: 2.3% (threshold: 1%)                             â”‚
â”‚ Status: âŒ FAILED - Auto-fix iteration 1/5                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Issues Found:                                                â”‚
â”‚   â€¢ Color mismatch in .header (Î” #1a1a30 â†’ #1a1a2e)         â”‚
â”‚   â€¢ Spacing issue in .card (padding: 12px â†’ 16px)           â”‚
â”‚   â€¢ Font size in .title (22px â†’ 24px)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Applying fixes...                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Success Output

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¨ VISUAL REGRESSION RESULT                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Pixel Diff: 0.4% (threshold: 1%)                             â”‚
â”‚ Status: âœ… PASSED after 3 iterations                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Fixes Applied:                                               â”‚
â”‚   â€¢ .header background-color                                 â”‚
â”‚   â€¢ .card padding                                            â”‚
â”‚   â€¢ .title font-size                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Integration with Workflow

### Phase 5 (TDD) - Component Implementation
- Implement component based on design
- Run visual regression after each component

### Phase 6 (Review) - Quality Check
- Run full visual regression suite
- Auto-fix any discrepancies

### Phase 7 (Verify) - Final Validation
- Compare all screens against Figma
- Generate visual diff report

---

## CRITICAL: Execution Requirements

When performing visual regression:

1. **DO** use Playwright MCP to capture screenshots
2. **DO** use Figma MCP to fetch design references (if available)
3. **DO** run the auto-fix loop until threshold met or max iterations
4. **DO** show the diff image to the user
5. **DO** report all fixes applied

**DON'T** just describe what would happen - actually execute the comparison.

---

## Commands

| Command | Description |
|---------|-------------|
| `/visual:test` | Run visual regression on current component |
| `/visual:compare <figma-url>` | Compare against specific Figma frame |
| `/visual:report` | Generate full visual regression report |
| `/visual:baseline` | Update baseline screenshots |

---

**Version:** 1.11.0
**Last Updated:** 2026-02-13
