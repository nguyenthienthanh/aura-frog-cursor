---
description: Approval gates - enforce mandatory user approval at each workflow phase transition
globs: []
alwaysApply: true
---

# Approval Gates - Phase Transition Control

**Version:** 2.0.0
**Purpose:** Streamlined 2-gate approval workflow
**Priority:** CRITICAL - Core workflow mechanism

---

## ğŸ¯ Core Principle (Streamlined Workflow)

**RULE:** Only **2 approval gates** - Phase 2 (Design) and Phase 5b (Implementation).

### Two Types of Phase Transitions

| Type | Phases | Behavior |
|------|--------|----------|
| **âœ‹ Approval Gate** | Phase 2, 5b | Execute â†’ Show deliverables â†’ **WAIT for approval** |
| **âš¡ Auto-Continue** | 1, 3, 4, 5a, 5c, 6, 7, 8, 9 | Execute â†’ Show deliverables â†’ **Continue automatically** |

### Flow Diagram

```
Approval Gate:     Execute â†’ Deliverables â†’ STOP â†’ Wait â†’ User approves â†’ Continue
Auto-Continue:     Execute â†’ Deliverables â†’ Continue (no wait)
```

**IMPORTANT:** Auto-continue phases are NOT skipped. They:
1. âœ… Execute fully
2. âœ… Show deliverables/summary
3. âœ… Continue automatically (no user action needed)

---

## ğŸš¦ Approval Gate Workflow

### State Machine

```
[Phase Execution]
      â†“
[Phase Complete]
      â†“
[Generate Summary]
      â†“
[Show Approval Prompt] â† YOU ARE HERE
      â†“
   Wait for user input...
      â†“
[User Response?]
   â”œâ”€ "approve" â†’ [Next Phase]
   â”œâ”€ "reject" â†’ [Rollback/Restart]
   â”œâ”€ "modify" â†’ [Stay in current phase]
   â””â”€ timeout â†’ [Stay in current phase]
```

---

## ğŸ“‹ Approval Prompt Format

### Standard Template

```markdown
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ¯ PHASE {N} COMPLETE: {Phase Name}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š **Summary:**
{Brief summary of what was accomplished}

ğŸ“¦ **Deliverables:**
- {Deliverable 1}
- {Deliverable 2}
- {Deliverable 3}

âœ… **Success Criteria Met:**
- [x] {Criterion 1}
- [x] {Criterion 2}
- [x] {Criterion 3}

â­ï¸  **Next Phase:** Phase {N+1} - {Next Phase Name}
{Brief description of what happens next}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âš ï¸  **ACTION REQUIRED**

Please review the above and respond:

Type "approve" â†’ Proceed to Phase {N+1}
Type "reject"  â†’ Restart Phase {N} with feedback
Type "modify"  â†’ Make changes before proceeding
Type "cancel"  â†’ Stop workflow

Your response:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ”’ Phase Transition Details

### âš¡ Phase 1: Requirements Analysis â†’ AUTO-CONTINUE
```yaml
Type: Auto-continue (no approval needed)
Must show:
  - Parsed requirements
  - Identified scope
  - Edge cases
  - Success criteria

Then: Continues automatically to Phase 2
```

### âœ‹ Phase 2: Technical Planning â†’ APPROVAL GATE (1 of 2)
```yaml
Type: APPROVAL REQUIRED
Must show:
  - Architecture diagram
  - Component breakdown
  - File changes list
  - Technology decisions

User confirms:
  - Approach is correct
  - No better alternatives
  - Acceptable complexity

After approval: Auto-continues through Phase 3, 4, 5a
```

### âš¡ Phase 3: Design Review â†’ AUTO-CONTINUE
```yaml
Type: Auto-continue (no approval needed)
Skip if: Backend-only task (no UI)
Must show:
  - UI/UX analysis
  - Component structure
  - Design alignment

Then: Continues automatically to Phase 4
```

### âš¡ Phase 4: Test Planning â†’ AUTO-CONTINUE
```yaml
Type: Auto-continue (no approval needed)
Must show:
  - Test strategy
  - Test cases list
  - Coverage plan

Then: Continues automatically to Phase 5a
```

### âš¡ Phase 5a: Write Tests (RED) â†’ AUTO-CONTINUE
```yaml
Type: Auto-continue (with auto-stop condition)
Must show:
  - Test files created
  - Test execution report (all failing)
  - Coverage report

AUTO-STOP if: Tests pass (they should fail!) â†’ Fix tests first
Then: Continues automatically to Phase 5b
```

### âœ‹ Phase 5b: Implementation (GREEN) â†’ APPROVAL GATE (2 of 2)
```yaml
Type: APPROVAL REQUIRED
Must show:
  - Implementation complete
  - Test execution report (all passing)
  - Coverage report (meets threshold)
  - Linter report (clean)
  - Files changed

User confirms:
  - Implementation correct
  - Tests pass
  - Coverage acceptable
  - Ready to refactor

After approval: Auto-continues through Phase 5c, 6, 7, 8, 9
```

### âš¡ Phase 5c: Refactor (REFACTOR) â†’ AUTO-CONTINUE
```yaml
Type: Auto-continue (with auto-stop condition)
Must show:
  - Refactored code
  - Test execution report (still passing)
  - Code quality improvements

AUTO-STOP if: Tests fail â†’ Revert refactor
Then: Continues automatically to Phase 6
```

### âš¡ Phase 6: Code Review â†’ AUTO-CONTINUE
```yaml
Type: Auto-continue (with auto-stop condition)
Must show:
  - Code review checklist
  - Issues found (if any)
  - Security findings
  - Quality score

AUTO-STOP if: Critical security issues found â†’ Fix first
Then: Continues automatically to Phase 7
```

### âš¡ Phase 7: QA Validation â†’ AUTO-CONTINUE
```yaml
Type: Auto-continue (with auto-stop condition)
Must show:
  - Test execution results
  - Coverage report
  - Bug report (if any)

AUTO-STOP if: Tests fail OR coverage < 80% â†’ Fix first
Then: Continues automatically to Phase 8
```

### âš¡ Phase 8: Documentation â†’ AUTO-CONTINUE
```yaml
Type: Auto-continue (no approval needed)
Must show:
  - Documentation created
  - Changes documented
  - Migration notes (if needed)

Then: Continues automatically to Phase 9
```

### âš¡ Phase 9: Notification â†’ AUTO-CONTINUE
```yaml
Type: Auto-continue (read-only)
Skip if: No Slack configured
Actions:
  - Send Slack notifications
  - Mark workflow complete

End of workflow âœ…
```

---

## ğŸ¨ User Response Handling

### Valid Responses

#### 1. "approve" / "approved" / "ok" / "proceed" / "continue" / "yes"
```yaml
Action: Proceed to next phase
Log: Save to .cursor/logs/workflow-{id}.log
Notify: "âœ… Proceeding to Phase {N+1}..."
```

#### 2. "reject" / "rejected" / "no" / "restart"
```yaml
Action: Restart current phase
Prompt: "What should be changed? Please provide feedback:"
Wait for: User feedback
Log: Save rejection reason to .cursor/logs/
Notify: "ğŸ”„ Restarting Phase {N} with feedback..."
```

#### 3. "modify" / "change" / "edit"
```yaml
Action: Stay in current phase, allow modifications
Prompt: "What modifications do you need?"
Wait for: User instructions
Log: Save modification request
Notify: "âœï¸ Making modifications..."
```

#### 4. "cancel" / "stop" / "abort"
```yaml
Action: Stop workflow
Prompt: "Are you sure? Type 'confirm' to cancel workflow."
Wait for: Confirmation
Save: Workflow state to .cursor/workflow-contexts/
Notify: "âŒ Workflow cancelled. State saved for resume."
```

#### 5. "back" / "previous"
```yaml
Action: Return to previous phase
Prompt: "Return to Phase {N-1}? Type 'confirm'."
Wait for: Confirmation
Log: Save rollback event
Notify: "âª Rolling back to Phase {N-1}..."
```

### Invalid Responses
```yaml
Examples: Random text, unclear input

Action:
  - Show error message
  - Re-display approval prompt
  - Suggest valid options

Message:
  "âŒ Invalid response. Please type one of:
   - 'approve' to proceed
   - 'reject' to restart
   - 'modify' to make changes
   - 'cancel' to stop"
```

---

## ğŸ“Š Workflow State Tracking

### State File: `.cursor/workflow-contexts/workflow-{id}/state.json`

```json
{
  "workflow_id": "refactor-social-post-20251130-143022",
  "current_phase": 2,
  "status": "waiting_approval",
  "phases": {
    "1": {
      "name": "Requirements Analysis",
      "status": "approved",
      "started_at": "2025-11-30T14:30:22Z",
      "completed_at": "2025-11-30T14:35:10Z",
      "approved_at": "2025-11-30T14:36:00Z",
      "approved_by": "user",
      "deliverables": [
        "requirements-analysis.md"
      ]
    },
    "2": {
      "name": "Technical Planning",
      "status": "waiting_approval",
      "started_at": "2025-11-30T14:36:05Z",
      "completed_at": "2025-11-30T14:45:30Z",
      "deliverables": [
        "tech-spec.md",
        "architecture-diagram.png"
      ]
    }
  },
  "context": {
    "task": "Refactor SocialMarketingCompositePost.phone.tsx",
    "agents": ["mobile-react-native", "qa-automation", "ui-designer"]
  }
}
```

---

## ğŸ›¡ï¸ Safety Mechanisms

### 1. Always Save State Before Approval
```yaml
Reason: User may close session, need to resume
Action: Save to .cursor/workflow-contexts/ after phase complete, before prompt
```

### 2. Prevent Accidental Skip
```yaml
Reason: Phases must run in order
Action: Disable "skip" command
Exception: User can go back, but not forward
```

### 3. Require Confirmation for Destructive Actions
```yaml
Actions requiring "confirm":
  - Cancel workflow
  - Rollback phase
  - Delete deliverables

Prompt: "Are you sure? Type 'confirm' to proceed."
```

### 4. Auto-save Every 5 Minutes
```yaml
During phase execution:
  - Save partial progress to .cursor/workflow-contexts/
  - Allow recovery if crashed
  - Show last saved time
```

---

## âœ… Approval Gate Checklist

Before showing approval prompt:

- [ ] Phase execution complete
- [ ] All deliverables generated
- [ ] Success criteria met
- [ ] Quality checks passed
- [ ] State saved to `.cursor/workflow-contexts/`
- [ ] Summary prepared
- [ ] Next phase identified

After user approves:

- [ ] Approval logged to `.cursor/logs/`
- [ ] State updated in `.cursor/workflow-contexts/`
- [ ] Notifications sent (if configured)
- [ ] Next phase started

---

## ğŸ¯ Success Criteria

Workflow gates are working correctly if:

1. âœ… Only 2 approval gates exist (Phase 2 & 5b)
2. âœ… Auto-continue phases EXECUTE fully (not skipped)
3. âœ… Auto-continue phases SHOW deliverables before continuing
4. âœ… Auto-stop conditions halt workflow when issues found
5. âœ… User can reject/modify/cancel at approval gates
6. âœ… State saved to `.cursor/workflow-contexts/` and recoverable
7. âœ… Transitions logged to `.cursor/logs/` for audit

---

## âŒ Common Mistakes to Avoid

| Mistake | Correct Behavior |
|---------|------------------|
| Skipping auto-continue phases entirely | Execute phase, show deliverables, then continue |
| Waiting for approval on all phases | Only wait at Phase 2 & 5b |
| Ignoring auto-stop conditions | Stop and fix issues before continuing |
| Not showing deliverables on auto phases | Always show what was done |

---

**Version:** 2.0.0
**Status:** âœ… PRODUCTION READY
**Last Updated:** 2026-01-02

---

**Remember:** Auto-continue â‰  Skip! Every phase executes and shows its work. We just don't stop for approval except at the 2 critical gates. ğŸš€
